---
title: "Test1"
runtime: shiny
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, eval = T, echo = F}
library(shiny)
library(ggplot2)
source("common2.R")
################################################################
######################## USER INTERFACE ########################
################################################################
ui <- 
  fluidPage( 
    #Set up tabs
    titlePanel("Cool Application"),
    
    sidebarLayout("",
      mainPanel(width = 12,
        tabsetPanel(
     ###########################
     ####### SCATTERPLOT #######
     ###########################
          tabPanel("Scatterplot", 
                   br(),
                   fluidRow(
                   ##############################################
                   ######## USER CONTROL PANEL (SIDEBAR) ########
                   ##############################################
                     column(3,
                            wellPanel(
                              #labels for data selection options
                              fluidRow(   column(2),   column(5, "x-axis"),   column(5, "y-axis")   ),
                              #row to select data types to view (such as RNAseq or DNA copy number)
                              fluidRow(
                                column(2, "Data"),
                                #input to select which data type is displayed on the x-axis
                                column(5,
                                       selectInput("datatype_x", NULL,c("DNA Copy Number"))
                                       ),
                                #input to select which data type is displayed on the y-axis
                                column(5,
                                       selectInput("datatype_y", NULL, c("DNA Copy Number"))
                                       )
                                ),
                              #row to select which gene to view
                              fluidRow(
                                column(2,"Gene"),
                                #input to select which gene is displayed on the x-axis
                                column(5,
                                       selectInput("gene_x", NULL,
                                                   c("A1BG" = "A1BG",
                                                     "---" = " ",
                                                     
                                                     "CDH2" = "CDH2"
                                                     ))
<<<<<<< HEAD
<<<<<<< HEAD

>>>>>>> 4ef257d6265b151ed739a2befec6bb84a8e1776a
=======
>>>>>>> 2c32fc4d29b0ff2e3d0c1a9c6feea73288e7cbe5
=======
>>>>>>> 2c32fc4d29b0ff2e3d0c1a9c6feea73288e7cbe5
                                       ),
                                #input to select which gene is displayed on the y-axis
                                column(5,
                                       selectInput("gene_y", NULL,
                                                   c("CDH2" = "CDH2",
                                                     "---" = " ",
                                                     "A1BG" = "A1BG",
                                                     "Gene1" = "gene1",
                                                     "Gene2" = "gene2",
                                                     "Gene3" = "gene3")))
                                )
                              ),
                            br(),
                            "Select a cancer type to highlight",
                            selectInput("variable", NULL,
                                        c("Cancer1" = "cancer1",
                                          "Cancer2" = "cancer2",
                                          "Cancer3" = "cancer3")),
                            checkboxInput("showSelected", "Show selected cancers only?", FALSE)
                            ),
                   ##################################################
                   ######## INFORMATION DISPLAY (MAIN PANEL) ########
                   ##################################################
                     column(9,
                            #####################################
                            ######## POINT DETAIL DISPLAY #######
                            #####################################
                            fluidRow(
                              #display details of the left plot ("zoomed-out" plot)
                              column(6, 
                                     #display details
                                     fluidRow(column(1),
                                              column(10,
                                                     wellPanel("Details 1a (cell line, cancer type)"))),
                                     fluidRow(column(1),
                                              column(10,
                                                     wellPanel("Details 1b (rnaseq info, dna copy, etc)",
                                                               verbatimTextOutput("click_info")
                                                               )
                                                     )
                                              )
                                     ),
                              #display details of the right plot ("zoomed-in" plot)
                              column(6,
                                     #only display IF the user has selected a potion of the left plot
                                     conditionalPanel(condition = 'output.brushActive != 0',
                                       fluidRow(column(1),
                                                column(10,
                                                     wellPanel("Details a2 (cell line, cancer type)"))
                                              ),
                                        fluidRow(column(1),
                                                 column(10,
                                                     wellPanel("Details 2b (rnaseq info, dna copy, etc)",
                                                               verbatimTextOutput("zoom_click_info")
                                                               )
                                                     )
                                              )
                                       )
                                     )
                            ),
                            #####################################
                            ######## SCATTERPLOT DISPLAY ########
                            #####################################
                            fluidRow(
                              #Display left ("zoomed-out") scatterplot
                              column(6,
                                     wellPanel(
                                                plotOutput("plot",
                                                           click = "plot_click",
                                                           brush = brushOpts(id="plot_brush")
                                                           )
                                                )
                                     ),
                              #Display right ("zoomed-in") scatterplot
                              column(6,
                                     #only display IF the user has selected a potion of the left plot
                                     conditionalPanel(condition = 'output.brushActive != 0',
                                                      wellPanel(
                                                       plotOutput("plot_zoom",
                                                                  click = "plot_zoom_click"))
                                                      )
                                     )
                              )
                            )
                   )
                  ),
     #######################
     ####### HEATMAP #######
     #######################   
          tabPanel("Heatmap", verbatimTextOutput("summary"))
        )
      )
    )
  )
########################################################
######################## SERVER ########################
########################################################
server <- function(input, output) {
    
  #BEGIN TEST VALUES
    x <- rnorm(500)
    y <- rnorm(500)
    testdata <- data.frame(x = x, y = y)
    plotdata <- reactiveValues(zoomdata=testdata)
  #END TEST VALUES
    
    inputdata_x <- readRDS("CCLE_copynumber_byGene_2013-12-03")
    inputdata_y <- inputdata_x 
    defaultplotdata <- inputdata_x
<<<<<<< HEAD
<<<<<<< HEAD
=======
    pnt <- NULL
>>>>>>> 2c32fc4d29b0ff2e3d0c1a9c6feea73288e7cbe5
=======
    pnt <- NULL
>>>>>>> 2c32fc4d29b0ff2e3d0c1a9c6feea73288e7cbe5
  ###################################
  ######## CHECK EVENT FLAGS ########
  ###################################
    #values for event flags
    flags <- reactiveValues(brushActive = 0)
    output$brushActive <- reactive({ return(flags$brushActive) })
    outputOptions(output, name = "brushActive", suspendWhenHidden = FALSE)
    
    #Check to see if the brush is active
    observeEvent(plotdata$zoomdata, {
     if(is.data.frame(plotdata$zoomdata) && nrow(plotdata$zoomdata)==0) {
        flags$brushActive <- 0
        print("brush is not active")
     }
      else{
        flags$brushActive <- 1
        print("brush is active!")
      }
    })
    observeEvent(input$plot_brush,{plotdata$zoomdata <- brushedPoints(testdata,input$plot_brush)})
  
  ##################################
  ####### RENDERING OUTPUTS ########
  ##################################
    
    #output the left/"zoomed-out" plot
    output$plot<- renderPlot({ 
      x_sel <<- input$gene_x
      y_sel <<- input$gene_y
      #Select the appropriate rows from our database table based on user input
      if(x_sel != " " && y_sel != " "){
        x <- sapply(inputdata_x[inputdata_x[,"SYMBOL"]==x_sel,-c(1:5)], as.numeric)
        y <- sapply(inputdata_y[inputdata_y[,"SYMBOL"]==y_sel,-c(1:5)], as.numeric)
        
        defaultplotdata <<- data.frame(x = x, y = y)
        defaultplot <<- ggplot() + geom_point(data = defaultplotdata, aes(x,y), alpha=.3, color="blue") + labs(x = x_sel, y = y_sel, title = "Test Scatter") 
        if(is.null(input$plot_click)){
          print("null")
<<<<<<< HEAD
<<<<<<< HEAD
=======
=======
>>>>>>> 2c32fc4d29b0ff2e3d0c1a9c6feea73288e7cbe5
          if(!is.null(pnt)){
            defaultplot + geom_point(data = pnt, aes(x,y), color="red", size = 2) 
          }
          else{
            defaultplot
          }
          
<<<<<<< HEAD
>>>>>>> 2c32fc4d29b0ff2e3d0c1a9c6feea73288e7cbe5
=======
>>>>>>> 2c32fc4d29b0ff2e3d0c1a9c6feea73288e7cbe5
        }
        else{
          pnt <<- nearPoints(defaultplotdata, input$plot_click, maxpoints = 1)
          print(pnt)
<<<<<<< HEAD
<<<<<<< HEAD
        }
        defaultplot + geom_point(data = pnt, aes(x,y), color="red", size = 2) 
=======
          defaultplot + geom_point(data = pnt, aes(x,y), color="red", size = 2) 
        }
        
>>>>>>> 2c32fc4d29b0ff2e3d0c1a9c6feea73288e7cbe5
=======
          defaultplot + geom_point(data = pnt, aes(x,y), color="red", size = 2) 
        }
        
>>>>>>> 2c32fc4d29b0ff2e3d0c1a9c6feea73288e7cbe5
      }
    }) 
    #output data associated with the selected point on the left/"zoomed-out" plot
    output$click_info <- renderPrint({
<<<<<<< HEAD
<<<<<<< HEAD
      if(!is.null(input$plot_click)){
        pnt <- nearPoints(defaultplotdata, input$plot_click, maxpoints = 1)
      }
      printPoint(pnt)
=======
=======
>>>>>>> 2c32fc4d29b0ff2e3d0c1a9c6feea73288e7cbe5
      if(is.null(input$plot_click)){
        printPoint(pnt)
      }
      else{
        pnt <- nearPoints(defaultplotdata, input$plot_click, maxpoints = 1)
        printPoint(pnt)
      }
<<<<<<< HEAD
>>>>>>> 2c32fc4d29b0ff2e3d0c1a9c6feea73288e7cbe5
=======
>>>>>>> 2c32fc4d29b0ff2e3d0c1a9c6feea73288e7cbe5
      
    })
    #output the right/"zoomed-out" plot
    output$plot_zoom<- renderPlot({ 
      print("zoom")
      plotdata$zoomdata <- brushedPoints(defaultplotdata,input$plot_brush)
      ggplot(plotdata$zoomdata, aes(x,y)) + geom_point(alpha=.5, color="blue")
    }) 
    #output data associated with the selected point on the right/"zoomed-in" plot
    output$zoom_click_info <- renderPrint({
      pnt <- nearPoints(defaultplotdata, input$plot_zoom_click, maxpoints = 1)
      printPoint(pnt)
    })
  
  #################################
  ######## VARIOUS FUNTIONS #######
  #################################
    
    printPoint <- function(pnt){
      underscore <- regexpr("_",rownames(pnt))
      cell_line <- substring(rownames(pnt), 1, underscore-1)
      cancer_type <- substring(rownames(pnt), underscore+1)
      print(paste('Cell Line: ',cell_line))
      print(paste("Cancer Type: ", cancer_type))
      print(paste(x_sel, ": ",pnt$x))
      print(paste(y_sel, ": ",pnt$y))
    }

}

shinyApp(ui = ui, server = server)
```
```{r, eval = F, echo = F}
##TESTING SPACE FOR READING A GCT AND DISPLAYING DATA
source("common2.R")
library(ggplot2)
testdata_Achilles <- read.gct("Achilles_v3.3.8.gct")$data
#print(head(testdata_Achilles, 10))
print(colnames(testdata_Achilles))
x_sel <- "MIR3129" #"A375_SKIN"
y_sel <- "SESTD1" #"A673_BONE"
x <- testdata_Achilles[grep(x_sel, rownames(testdata_Achilles)),][1,]
y <- testdata_Achilles[grep(y_sel, rownames(testdata_Achilles)),][1,]
print(x)
print(y)
plotdata= data.frame(x = x, y = y)
p<-ggplot(plotdata, aes(x,y)) + geom_point(alpha=.3, color="blue") + labs(x = x_sel, y = y_sel, title = "Test Scatter")
p


#print(testdata_Achilles[,"A375_SKIN"])
#print(testdata_Achilles[,"A673_BONE"])
# stuff <- read.gct("Achilles_v3.3.8_rawreadcounts.gct")$data
# stuff <- read.table("CCLE_copynumber_byGene_2013-12-03.txt",sep ="\t",header=T)
# #print(stuff)
# 
#  annotation <- read.table("CCLE_sample_info_file_2012-10-18.txt",sep ="\t",header=T)
# 
#  list <- annotation[,c("CCLE.name","Site.Primary")]
# list <- split(list[,"CCLE.name"],list[,"Site.Primary"])
#  #print(list)
#  stuff1 <- do.call(cbind, lapply(list, function(x){
#     rowMeans(stuff[,as.character(x)])
#   }))
# 
#  underscore <- regexpr("_",colnames(stuff))
#  cell_lines <- substring(colnames(stuff), 1, underscore-1)
#  cancer_type <- substring(colnames(stuff), underscore+1)
#  skin <- stuff[,grep("EGID|SYMBOL|CHR|CHRLOC|CHRLOCEND|SKIN", colnames(stuff))]
# 
#  for(i in cell_lines){
#    columns <- grep(i, colnames(stuff))
# 
# }
# 
# 
# table(list$Site.Primary)
# 
# correlations <- cor(stuff[,6:30])
# heatmap(correlations)
```
```{r, eval = F, echo = F}
##TESTING SPACE FOR READING A TXT AND DISPLAYING THE DATA
source("common2.R")
library(ggplot2)
testdata_txt <- readRDS("CCLE_copynumber_byGene_2013-12-03")
x_sel <- "A1BG"
y_sel <- "CDH2"
print(head(testdata_txt))
#Select the appropriate rows from our database table based on user input
x <- sapply(testdata_txt[testdata_txt[,"SYMBOL"]==x_sel,-c(1:5)], as.numeric)
y <- sapply(testdata_txt[testdata_txt[,"SYMBOL"]==y_sel,-c(1:5)], as.numeric)

plotdata <- data.frame(x = x, y = y)
p<-ggplot(plotdata, aes(x,y)) + geom_point(alpha=.3, color="blue") + labs(x = x_sel, y = y_sel, title = "Test Scatter")
p


```
